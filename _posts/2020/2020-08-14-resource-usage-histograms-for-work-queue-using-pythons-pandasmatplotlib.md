---
layout: "post"
title: "Resource usage histograms for Work Queue using python's pandas+matplotlib"
date: 2020-08-14T15:51:00+00:00
author: "Benjamin Tovar"
image: "/assets/blog/2020/resource-usage-histograms-for-work-queue-using-pythons-pandasmatplotlib/Screenshot-from-2020-08-14-11-43-14-b96ccea36d.png"
description: "Work Queue is a framework to write and execute master-worker applications. A master process that can be written in python, perl, or C generates the tasks tha…"
toc: false
related_posts: true
tags: []
---
<blockquote><p><a href="https://cctools.readthedocs.io/en/latest/work_queue/">Work Queue</a> is a framework to write and execute master-worker applications. A master process that can be written in python, perl, or C generates the tasks that then can be remotely executed by worker processes. You can learn more about Work Queue <a href="https://cctools.readthedocs.io/en/latest/work_queue/">here</a>.<br/><br/>Work Queue can automatically measure the resources, such as cores, memory, disk, and network bandwidth, used by each task. In python, this is enabled as:<br/></p></blockquote>

<pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;"><span></span>import</span> <span style="color: #0e84b5; font-weight: bold;">work_queue</span> <span style="color: #008800; font-weight: bold;">as</span> <span style="color: #0e84b5; font-weight: bold;">wq</span>
<span></span>q <span style="color: #333333;">=</span> wq<span style="color: #333333;">.</span>WorkQueue(port<span style="color: #333333;">=</span><span style="color: #0000dd; font-weight: bold;">9123</span>)
q<span style="color: #333333;">.</span>enable_monitoring()</pre>

<p>The resources measured are available as part of the task structure:<br/></p>

<pre style="line-height: 125%; margin: 0;"><span style="color: #888888;"># wait for 5 seconds for a task to finish</span>
t <span style="color: #333333;">=</span> q<span style="color: #333333;">.</span>wait(<span style="color: #0000dd; font-weight: bold;">5</span>)
<span style="color: #008800; font-weight: bold;">if</span> t:
    <span style="color: #008800; font-weight: bold;">print</span>(<span style="background-color: #fff0f0;">"Task {id} measured memory: {memory} MB"</span><span style="color: #333333;"> </span></pre>

<pre style="line-height: 125%; margin: 0;"><span style="color: #333333;"><span>    </span><span>    </span><span>    </span>.</span>format(<span style="color: #007020;">id</span><span style="color: #333333;">=</span>t<span style="color: #333333;">.</span>id, memory<span style="color: #333333;">=</span>t<span style="color: #333333;">.</span>resources_measured<span style="color: #333333;">.</span>memory))
<br/></pre>

<p>The resources measured are also written to Work Queue's transaction log. <span></span>This log can be enabled when declaring the master's queue:</p>

<pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">work_queue</span> <span style="color: #008800; font-weight: bold;">as</span> <span style="color: #0e84b5; font-weight: bold;">wq</span>
q <span style="color: #333333;">=</span> wq<span style="color: #333333;">.</span>WorkQueue(port<span style="color: #333333;">=</span><span style="color: #0000dd; font-weight: bold;">9123</span>, transactions_log<span style="color: #333333;">=</span><span style="background-color: #fff0f0;">'my_wq_trans.log'</span>)
q<span style="color: #333333;">.</span>enable_monitoring()</pre>

<p>This log is also generated by <a href="https://cctools.readthedocs.io/en/latest/makeflow/">Makeflow</a> when using Work Queue as a batch system (-Twq).<br/><br/><span>    </span>The resource information per task appears as a json object in the transactions marked as <span style="font-family: courier;">DONE end-state exit-code resource-exhausted resources-measured</span>. Here is an example of how a <span style="font-family: courier;">DONE</span> transaction looks like:</p>

<pre style="line-height: 125%; margin: 0;">1595431788501342 10489 TASK 1 DONE SUCCESS  0  {} {"cores": 2, ...}</pre>

<p>With a regular expression incantation, we can extract the resource information into python's pandas. Say, for example, that we are interested in the memory and bandwidth distribution among the executed tasks. We can read these resources as follows:</p>

<pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">json</span>
<span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">re</span>
<span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">pandas</span> <span style="color: #008800; font-weight: bold;">as</span> <span style="color: #0e84b5; font-weight: bold;">pd</span>
<span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">matplotlib.pyplot</span> <span style="color: #008800; font-weight: bold;">as</span> <span style="color: #0e84b5; font-weight: bold;">plt</span>

<span style="color: #888888;"># the list of the resources we are interested in</span>
resources <span style="color: #333333;">=</span> <span style="background-color: #fff0f0;">'memory bandwidth'</span><span style="color: #333333;">.</span>split()
df <span style="color: #333333;">=</span> pd<span style="color: #333333;">.</span>DataFrame(columns<span style="color: #333333;">=</span>resources)

input_file <span style="color: #333333;">=</span> <span style="background-color: #fff0f0;">'my_wq_trans.log'</span>

<span style="color: #008800; font-weight: bold;">with</span> <span style="color: #007020;">open</span>(input_file) <span style="color: #008800; font-weight: bold;">as</span> <span style="color: #007020;">input</span>:
    <span style="color: #008800; font-weight: bold;">for</span> line <span style="color: black; font-weight: bold;">in</span> <span style="color: #007020;">input</span>:
        <span style="color: #888888;"># timestamp master-pid TASK id (continue next line)</span></pre>

<pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">        # DONE SUCCESS exit-code exceeded measured</span>
        m <span style="color: #333333;">=</span> re<span style="color: #333333;">.</span>match(<span style="background-color: #fff0f0;">'\d+\s+\d+\s+TASK\s+\d+\s+'</span></pre>

<pre style="line-height: 125%; margin: 0;"><span style="background-color: #fff0f0;">                     'DONE\s+SUCCESS\s+0\s+{}\s+({.*})\s*$'</span>, line)
        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: black; font-weight: bold;">not</span> m:
            <span style="color: #008800; font-weight: bold;">continue</span>

        <span style="color: #888888;"># the resources are captured in the first (only pair</span></pre>

<pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">        # of parentheses) group used:</span>
        s <span style="color: #333333;">=</span> json<span style="color: #333333;">.</span>loads(m<span style="color: #333333;">.</span>group(<span style="color: #0000dd; font-weight: bold;">1</span>))

        <span style="color: #888888;"># append the new resources to the panda's data frame.</span></pre>

<pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">        # Resources are</span> <span style="color: #888888;">represented in a json array as</span></pre>

<pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">        # [value, "unit", such as [1000, "MB"],</span>
        <span style="color: #888888;"># so we only take the first element of the array:</span>
        df<span style="color: #333333;">.</span>loc[<span style="color: #007020;">len</span>(df)] <span style="color: #333333;">=</span> <span style="color: #007020;">list</span>(s[r][<span style="color: #0000dd; font-weight: bold;">0</span>] <span style="color: #008800; font-weight: bold;">for</span> r <span style="color: black; font-weight: bold;">in</span> resources)
</pre>

<p>For a quick view, we can directly use panda's histogram method:</p>

<pre style="line-height: 125%; margin: 0;">df<span style="color: #333333;">.</span>hist()
plt<span style="color: #333333;">.</span>show()</pre>

<pre style="line-height: 125%; margin: 0;"> </pre>

<div class="row justify-content-sm-center">
  <div class="col-sm-12">
    {% include figure.liquid path="/assets/blog/2020/resource-usage-histograms-for-work-queue-using-pythons-pandasmatplotlib/Screenshot-from-2020-08-14-11-43-14-b96ccea36d.png" title="" class="img-fluid rounded z-depth-1" zoomable=true %}
  </div>
</div>

<pre style="line-height: 125%; margin: 0;"> </pre>

<p>However, we can use matplotlib's facilities for subfigures and add titles,<br/>units, etc. to the histograms:<br/></p>

<pre style="line-height: 125%; margin: 0;"><span style="color: #888888;"># size width x height in inches</span>
fig <span style="color: #333333;">=</span> plt<span style="color: #333333;">.</span>figure(figsize<span style="color: #333333;">=</span>(<span style="color: #0000dd; font-weight: bold;">5</span>,<span style="color: #0000dd; font-weight: bold;">2</span>))

<span style="color: #888888;"># 1 row, 2 columns, 1st figure of the array</span>
mem <span style="color: #333333;">=</span> plt<span style="color: #333333;">.</span>subplot(<span style="color: #0000dd; font-weight: bold;">121</span>)
mem<span style="color: #333333;">.</span>set_title(<span style="background-color: #fff0f0;">'memory in MB'</span>)
mem<span style="color: #333333;">.</span>set_ylabel(<span style="background-color: #fff0f0;">'task count'</span>)
mem<span style="color: #333333;">.</span>hist(df[<span style="background-color: #fff0f0;">'memory'</span>], <span style="color: #007020;">range</span><span style="color: #333333;">=</span>(<span style="color: #0000dd; font-weight: bold;">0</span>,<span style="color: #0000dd; font-weight: bold;">100</span>))

<span style="color: #888888;"># 1 row, 2 columns, 2nd figure of the array</span>
mbp <span style="color: #333333;">=</span> plt<span style="color: #333333;">.</span>subplot(<span style="color: #0000dd; font-weight: bold;">122</span>)
mbp<span style="color: #333333;">.</span>set_title(<span style="background-color: #fff0f0;">'bandwidth in Mbps'</span>)
mbp<span style="color: #333333;">.</span>hist(df[<span style="background-color: #fff0f0;">'bandwidth'</span>], <span style="color: #007020;">range</span><span style="color: #333333;">=</span>(<span style="color: #0000dd; font-weight: bold;">0</span>,<span style="color: #0000dd; font-weight: bold;">1200</span>))

fig<span style="color: #333333;">.</span>savefig(input_file <span style="color: #333333;">+</span> <span style="background-color: #fff0f0;">'.png'</span>) </pre>

<pre style="line-height: 125%; margin: 0;"> </pre>

<pre style="line-height: 125%; margin: 0;"><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjeHwbr2eQ38Gw6F4wT5XQ0kZRW-nTHnxGaeTriF53S3tcm5Mfvwzkv8hOB7iOeSE7LuhSE00-LxOVlpDXR589_XNGitOsdc3LejNqhj186wT845h0Qy8IkWqtHg05kkPuoqEa_fOgq2RRf/s500/tr-bw-1-deep.log.log.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="160" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjeHwbr2eQ38Gw6F4wT5XQ0kZRW-nTHnxGaeTriF53S3tcm5Mfvwzkv8hOB7iOeSE7LuhSE00-LxOVlpDXR589_XNGitOsdc3LejNqhj186wT845h0Qy8IkWqtHg05kkPuoqEa_fOgq2RRf/w400-h160/tr-bw-1-deep.log.log.png" width="400"/></a></div> </pre>

<pre style="line-height: 125%; margin: 0;"> </pre>

<pre style="line-height: 125%; margin: 0;"> </pre>

<pre style="line-height: 125%; margin: 0;"> </pre>

<pre style="line-height: 125%; margin: 0;">(credit: Python code highlight generated by: <a href="http://hilite.me">http://hilite.me</a>)<br/></pre>

<pre style="line-height: 125%; margin: 0;"> </pre>
